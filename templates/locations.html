{% extends 'base.html' %}
{% block title %}Locations{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #locations-map { width:100%; height:400px; margin-bottom:1rem; }
  </style>
{% endblock %}

{% block content %}
<div class="card">
  <h2>Locations</h2>

  {% if locations %}
    <div id="locations-map"></div>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr><th>ID</th><th>Latitude</th><th>Longitude</th><th>Address</th><th>Created At</th></tr>
        </thead>
        <tbody>
          {% for loc in locations %}
          <tr>
            <td>{{ loc.id }}</td>
            <td>{{ "%.6f"|format(loc.latitude) }}</td>
            <td>{{ "%.6f"|format(loc.longitude) }}</td>
            <td>{{ loc.address }}</td>
            <td>{{ loc.created_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- pagination -->
       <!-- pagination as button group -->
       {% set group      = ((page - 1) // 10) %}
       {% set start_page = group * 10 + 1 %}
       {% set end_page   = (start_page + 9) if (start_page + 9) <= total_pages else total_pages %}
   
       <nav aria-label="Locations pagination">
         <div class="d-flex justify-content-center my-3">
           <div class="btn-group" role="group">
   
             <!-- Prev -->
             <button
               type="button"
               class="btn btn-outline-secondary"
               {% if page <= 1 %} disabled {% endif %}
               onclick="location.href='{{ url_for('locations', page=page-1) }}'">
               &laquo; Prev
             </button>
   
             <!-- Numbered pages -->
             {% for p in range(start_page, end_page + 1) %}
             <button
               type="button"
               class="btn {% if p == page %}btn-primary{% else %}btn-outline-secondary{% endif %}"
               onclick="location.href='{{ url_for('locations', page=p) }}'">
               {{ p }}
             </button>
             {% endfor %}
   
             <!-- Next -->
             <button
               type="button"
               class="btn btn-outline-secondary"
               {% if page >= total_pages %} disabled {% endif %}
               onclick="location.href='{{ url_for('locations', page=page+1) }}'">
               Next &raquo;
             </button>
   
           </div>
         </div>
       </nav>   

  {% else %}
    <p>No locations found.</p>
  {% endif %}

  <a href="{{ url_for('dashboard') }}" class="button" style="margin-top:1rem;">Back</a>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    {% if locations %}
    const coords = {{ locations|tojson }};
    const map    = L.map('locations-map')
                     .setView([coords[0].latitude, coords[0].longitude], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    coords.forEach(loc => {
      L.marker([loc.latitude, loc.longitude])
       .addTo(map)
       .bindPopup(`<strong>${loc.address}</strong><br/>ID: ${loc.id}`);
    });
    {% endif %}
  </script>
{% endblock %}
